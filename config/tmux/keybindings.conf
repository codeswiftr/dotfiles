# ============================================================================
# Tmux Key Bindings
# Custom key mappings and navigation shortcuts
# ============================================================================

# Reload configuration
bind r source-file ~/.tmux.conf \; display "Config reloaded!"

# Edit configuration
bind e new-window -n "~/.tmux.conf" "EDITOR=\${EDITOR//mvim/vim} && EDITOR=\${EDITOR//gvim/vim} && \${EDITOR:-nvim} ~/.tmux.conf && tmux source ~/.tmux.conf && tmux display \"~/.tmux.conf sourced\""

# Better window splitting
bind | split-window -h -c "#{pane_current_path}"
bind - split-window -v -c "#{pane_current_path}"
bind c new-window -c "#{pane_current_path}"
unbind '"'
unbind %

# Pane navigation (vim-like)
bind h select-pane -L
bind j select-pane -D
bind k select-pane -U
bind l select-pane -R

# Pane resizing
bind -r H resize-pane -L 5
bind -r J resize-pane -D 5
bind -r K resize-pane -U 5
bind -r L resize-pane -R 5

# Window navigation
bind -r C-h previous-window
bind -r C-l next-window
bind Tab last-window

# Session navigation
bind C-f command-prompt -p find-session 'switch-client -t %%'

# Quick TODO window
bind -r T split-window -b -p 35 -h -c "#{pane_current_path}" "[[ -e TODO.md ]] && nvim TODO.md || nvim ~/dotfiles/todo.md"

# Copy mode improvements
set-window-option -g mode-keys vi

# Mouse selection and copy mode bindings
bind-key -T copy-mode-vi v send-keys -X begin-selection
bind-key -T copy-mode-vi V send-keys -X select-line
bind-key -T copy-mode-vi r send-keys -X rectangle-toggle
bind-key -T copy-mode-vi Escape send-keys -X cancel

# Mouse drag to enter copy mode and select
bind-key -T root MouseDrag1Pane if-shell -F -t = "#{mouse_any_flag}" "send-keys -M" "copy-mode -M"

# Double click to select word
bind-key -T root DoubleClick1Pane select-pane \; copy-mode -M \; send-keys -X select-word \; run-shell "sleep .5s" \; send-keys -X copy-pipe-and-cancel

# Triple click to select line  
bind-key -T root TripleClick1Pane select-pane \; copy-mode -M \; send-keys -X select-line

# Enhanced cross-platform clipboard integration
# macOS
if-shell "test $(uname) = 'Darwin'" \
    "bind-key -T copy-mode-vi y send-keys -X copy-pipe-and-cancel 'pbcopy'; \
     bind-key -T copy-mode-vi Enter send-keys -X copy-pipe-and-cancel 'pbcopy'; \
     bind-key -T copy-mode-vi MouseDragEnd1Pane send-keys -X copy-pipe-and-cancel 'pbcopy'"

# Linux with X11
if-shell "test $(uname) = 'Linux' && command -v xclip" \
    "bind-key -T copy-mode-vi y send-keys -X copy-pipe-and-cancel 'xclip -in -selection clipboard'; \
     bind-key -T copy-mode-vi Enter send-keys -X copy-pipe-and-cancel 'xclip -in -selection clipboard'; \
     bind-key -T copy-mode-vi MouseDragEnd1Pane send-keys -X copy-pipe-and-cancel 'xclip -in -selection clipboard'"

# Linux with Wayland
if-shell "test $(uname) = 'Linux' && command -v wl-copy && test -n '$WAYLAND_DISPLAY'" \
    "bind-key -T copy-mode-vi y send-keys -X copy-pipe-and-cancel 'wl-copy'; \
     bind-key -T copy-mode-vi Enter send-keys -X copy-pipe-and-cancel 'wl-copy'; \
     bind-key -T copy-mode-vi MouseDragEnd1Pane send-keys -X copy-pipe-and-cancel 'wl-copy'"

# WSL (Windows Subsystem for Linux)
if-shell "test -n '$WSL_DISTRO_NAME' || grep -qi microsoft /proc/version 2>/dev/null" \
    "bind-key -T copy-mode-vi y send-keys -X copy-pipe-and-cancel 'clip.exe'; \
     bind-key -T copy-mode-vi Enter send-keys -X copy-pipe-and-cancel 'clip.exe'; \
     bind-key -T copy-mode-vi MouseDragEnd1Pane send-keys -X copy-pipe-and-cancel 'clip.exe'"

# Fallback for other systems
if-shell "test $(uname) != 'Darwin' && ! command -v xclip && ! command -v wl-copy && test -z '$WSL_DISTRO_NAME'" \
    "bind-key -T copy-mode-vi y send-keys -X copy-selection; \
     bind-key -T copy-mode-vi Enter send-keys -X copy-selection; \
     bind-key -T copy-mode-vi MouseDragEnd1Pane send-keys -X copy-selection"

# Enhanced paste functionality
# macOS paste
if-shell "test $(uname) = 'Darwin'" \
    "bind-key p run-shell 'tmux set-buffer \"$(pbpaste)\"; tmux paste-buffer'"

# Linux X11 paste
if-shell "test $(uname) = 'Linux' && command -v xclip" \
    "bind-key p run-shell 'tmux set-buffer \"$(xclip -o -selection clipboard)\"; tmux paste-buffer'"

# Linux Wayland paste
if-shell "test $(uname) = 'Linux' && command -v wl-paste && test -n '$WAYLAND_DISPLAY'" \
    "bind-key p run-shell 'tmux set-buffer \"$(wl-paste)\"; tmux paste-buffer'"

# WSL paste
if-shell "test -n '$WSL_DISTRO_NAME' || grep -qi microsoft /proc/version 2>/dev/null" \
    "bind-key p run-shell 'tmux set-buffer \"$(powershell.exe Get-Clipboard)\"; tmux paste-buffer'"

# Advanced clipboard commands
bind-key C-c run-shell "tmux show-buffer | head -c 2000"  # Show clipboard content
bind-key C-v run-shell "~/dotfiles/scripts/tmux-clipboard.sh paste | tmux load-buffer - && tmux paste-buffer"

# Clipboard management shortcuts
bind-key C-s run-shell "~/dotfiles/scripts/tmux-clipboard.sh status"  # Show clipboard status
bind-key C-t run-shell "~/dotfiles/scripts/tmux-clipboard.sh test"    # Test clipboard functionality

# Maximize/minimize pane
bind + run 'cut -c3- ~/.tmux.conf | sh -s _maximize_pane "#{session_name}" #D'

# Project session management
bind P command-prompt -p "Project session name:" "new-session -d -s %% -c ~/work/%%"
bind S choose-session

# Development layout shortcuts
bind D run-shell "~/.config/tmux/scripts/dev-layout.sh"
bind A run-shell "~/.config/tmux/scripts/ai-layout.sh"
bind W run-shell "~/.config/tmux/scripts/web-layout.sh"

# AI integration shortcuts
bind C-c run-shell "tmux new-window -n 'Claude' 'claude'"
bind C-g run-shell "tmux new-window -n 'Gemini' 'gemini'"
bind C-a run-shell "tmux new-window -n 'Aider' 'aider'"
bind C-r split-window -h -c "#{pane_current_path}" "ai-review-branch"
bind C-d split-window -h -c "#{pane_current_path}" "ai-analyze documentation"